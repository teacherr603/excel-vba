<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>VBA</title>
  <style>
    body {
      font-family: "Courier New", monospace;
      background-color: #f4f4f4;
      padding: 20px;
      line-height: 1.6;
    }
    .content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      white-space: pre-wrap;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h2></h2>
  <div class="content">
   Sub Collect_ScreenID_Time_By_UserID_ConvertTime()
    Dim folderPath As String, fileName As String
    Dim wb As Workbook, ws As Worksheet
    Dim resultWb As Workbook, resultWs As Worksheet
    Dim userDict As Object, dataDict As Object
    Dim i As Long, lastRow As Long
    Dim userID As String, screenID As String, timeVal As String
    Dim key As String, uid As Variant
    Dim userList As Variant
    Dim outputRow As Long
    Dim arrKey

    ' 优化：关闭动画
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    Application.EnableEvents = False

    ' 文件夹选择
    With Application.FileDialog(msoFileDialogFolderPicker)
        If .Show <> -1 Then Exit Sub
        folderPath = .SelectedItems(1) & "\"
    End With

    ' 指定的15个用户
    userList = Array("aaa001", "bbb002", "ccc003", "ddd004", "eee005", _
                     "fff006", "ggg007", "hhh008", "iii009", "jjj010", _
                     "kkk011", "lll012", "mmm013", "nnn014", "ooo015")

    Set userDict = CreateObject("Scripting.Dictionary")
    For i = 0 To UBound(userList)
        userDict(userList(i)) = CreateObject("Scripting.Dictionary")
    Next i

    fileName = Dir(folderPath & "*.xls*")
    Do While fileName <> ""
        On Error Resume Next
        Set wb = Workbooks.Open(folderPath & fileName, ReadOnly:=True)
        If Err.Number <> 0 Then
            Debug.Print "无法打开：" & fileName
            Err.Clear: fileName = Dir(): On Error GoTo 0: Continue Do
        End If
        On Error GoTo 0

        For Each ws In wb.Worksheets
            ' 第三列时间列转换为文字列
            With ws.Columns(3)
                .NumberFormat = "@"
                For i = 2 To ws.Cells(ws.Rows.Count, 3).End(xlUp).Row
                    .Cells(i).Value = .Cells(i).Text
                Next i
            End With

            lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
            For i = 2 To lastRow
                userID = Trim(ws.Cells(i, 1).Text)
                If userDict.exists(userID) Then
                    screenID = Trim(ws.Cells(i, 2).Text)
                    timeVal = Trim(ws.Cells(i, 3).Text) ' 此时已经是文字列

                    If screenID <> "" And timeVal <> "" Then
                        key = screenID & "|" & timeVal
                        dataDict = userDict(userID)
                        If dataDict.exists(key) Then
                            dataDict(key) = dataDict(key) + 1
                        Else
                            dataDict(key) = 1
                        End If
                    End If
                End If
            Next i
        Next ws

        wb.Close False
        fileName = Dir()
    Loop

    ' 输出到結果.xlsx
    Set resultWb = Workbooks.Add

    For Each uid In userDict.Keys
        Set resultWs = resultWb.Sheets.Add(After:=resultWb.Sheets(resultWb.Sheets.Count))
        resultWs.Name = uid
        resultWs.Cells(1, 1).Value = "画面ID"
        resultWs.Cells(1, 2).Value = "時間"
        resultWs.Cells(1, 3).Value = "数量"

        outputRow = 2
        Set dataDict = userDict(uid)
        For Each key In dataDict.Keys
            arrKey = Split(key, "|")
            resultWs.Cells(outputRow, 1).Value = arrKey(0)
            resultWs.Cells(outputRow, 2).Value = arrKey(1)
            resultWs.Cells(outputRow, 3).Value = dataDict(key)
            outputRow = outputRow + 1
        Next
    Next

    resultWb.SaveAs folderPath & "結果.xlsx"
    resultWb.Close

    ' 恢复动画
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    Application.EnableEvents = True

    MsgBox "完了しました！"
End Sub



  </div>
</body>
</html>

