<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>VBA</title>
  <style>
    body {
      font-family: "Courier New", monospace;
      background-color: #f4f4f4;
      padding: 20px;
      line-height: 1.6;
    }
    .content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      white-space: pre-wrap;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h2></h2>
  <div class="content">
Sub 集計_画面ID_月時単位_完全版()

    Dim folderPath As String
    folderPath = "C:\Your\Folder\Path\"  ' ← 请修改为你实际文件夹路径，末尾带“\”

    ' 用户ID列表
    Dim userList As Variant
    userList = Array("A1234567", "B2345678", "C3456789", "D4567890", "E5678901", _
                     "F6789012", "G7890123", "H8901234", "I9012345", "J0123456", _
                     "K1234567", "L2345678", "M3456789", "N4567890", "O5678901")

    ' 初始化字典
    Dim userDict As Object: Set userDict = CreateObject("Scripting.Dictionary")
    Dim i As Long
    For i = 0 To UBound(userList)
        Set userDict(userList(i)) = CreateObject("Scripting.Dictionary")
    Next i

    ' 遍历 Excel 文件
    Dim fso As Object: Set fso = CreateObject("Scripting.FileSystemObject")
    Dim folder As Object: Set folder = fso.GetFolder(folderPath)
    Dim file As Object, wb As Workbook, ws As Worksheet
    Dim lastRow As Long
    Dim uid As String, sid As String, tVal As Variant
    Dim monHour As String, key As String

    For Each file In folder.Files
        If LCase(fso.GetExtensionName(file.Name)) Like "xls*" Then
            On Error Resume Next
            Set wb = Workbooks.Open(file.Path, ReadOnly:=True)
            On Error GoTo 0
            If Not wb Is Nothing Then
                Set ws = wb.Sheets(1)
                lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row

                For i = 2 To lastRow
                    uid = Trim(ws.Cells(i, 1).Value)
                    If userDict.exists(uid) Then
                        sid = Trim(ws.Cells(i, 2).Value)
                        tVal = ws.Cells(i, 3).Value

                        If IsDate(tVal) Then
                            monHour = Format(tVal, "mmhh")  ' 月+小时
                            key = sid & "||" & monHour
                            If Not userDict(uid).exists(key) Then
                                userDict(uid)(key) = 1
                            Else
                                userDict(uid)(key) = userDict(uid)(key) + 1
                            End If
                        End If
                    End If
                Next i
                wb.Close False
            End If
        End If
    Next file

    ' 创建结果工作簿
    Dim resultWb As Workbook, resultWs As Worksheet
    Dim resultPath As String: resultPath = folderPath & "結果.xlsx"
    On Error Resume Next: Workbooks("結果.xlsx").Close False: On Error GoTo 0
    Set resultWb = Workbooks.Add

    Dim uidKey As Variant, dataDict As Object, keyItem As Variant
    Dim parts() As String
    Dim rowIndex As Long

    For Each uidKey In userList
        Set resultWs = resultWb.Sheets.Add(After:=resultWb.Sheets(resultWb.Sheets.Count))
        resultWs.Name = uidKey
        resultWs.Range("A1:C1").Value = Array("画面ID", "月+時", "出現回数")
        rowIndex = 2

        Set dataDict = userDict(uidKey)
        If Not dataDict Is Nothing Then
            For Each keyItem In dataDict.Keys
                parts = Split(keyItem, "||")
                resultWs.Cells(rowIndex, 1).Value = parts(0)
                resultWs.Cells(rowIndex, 2).Value = parts(1)
                resultWs.Cells(rowIndex, 3).Value = dataDict(keyItem)
                rowIndex = rowIndex + 1
            Next
        End If
    Next uidKey

    ' 删除默认 Sheet
    Application.DisplayAlerts = False
    Dim tmpWs As Worksheet
    For Each tmpWs In resultWb.Sheets
        If tmpWs.Name Like "Sheet*" Then tmpWs.Delete
    Next tmpWs
    Application.DisplayAlerts = True

    ' 保存
    resultWb.SaveAs resultPath
    resultWb.Close False

    MsgBox "処理が完了しました。出力ファイル：" & resultPath

End Sub


  </div>
</body>
</html>

