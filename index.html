<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>VBA</title>
  <style>
    body {
      font-family: "Courier New", monospace;
      background-color: #f4f4f4;
      padding: 20px;
      line-height: 1.6;
    }
    .content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      white-space: pre-wrap;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h2></h2>
  <div class="content">
Sub CollectUserScreenTimeFrequency()
    Dim folderPath As String
    Dim fileName As String
    Dim wb As Workbook, ws As Worksheet
    Dim lastRow As Long, i As Long
    Dim row As Long
    Dim userList As Variant
    Dim userDict As Object
    Dim currentUser As String
    Dim screenId As String, timeVal As String, key As String
    Dim dataDict As Object
    Dim resultWb As Workbook, resultWs As Worksheet
    Dim outputCount As Long

    ' 対象ユーザーID（15個）
    userList = Array("aaaa", "bbbb", "cccc", "dddd", "eeee", _
                     "ffff", "gggg", "hhhh", "iiii", "jjjj", _
                     "kkkk", "llll", "mmmm", "nnnn", "oooo")

    ' ユーザーごとの辞書初期化
    Set userDict = CreateObject("Scripting.Dictionary")
    For i = 0 To UBound(userList)
        userDict(userList(i)) = CreateObject("Scripting.Dictionary")
    Next

    ' フォルダパス（このブックと同じ場所）
    folderPath = ThisWorkbook.Path & "\"
    If Right(folderPath, 1) <> "\" Then folderPath = folderPath & "\"
    
    fileName = Dir(folderPath & "*.xls*")
    Do While fileName <> ""
        On Error Resume Next
        Set wb = Workbooks.Open(folderPath & fileName, ReadOnly:=True)
        If Err.Number <> 0 Then
            Debug.Print "ファイルを開けません: " & fileName
            Err.Clear
            GoTo SkipFile
        End If
        On Error GoTo 0

        For Each ws In wb.Worksheets
            lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
            For row = 2 To lastRow
                currentUser = Trim(ws.Cells(row, 1).Value)
                screenId = Trim(ws.Cells(row, 2).Value)
                timeVal = Trim(ws.Cells(row, 3).Text)

                If userDict.exists(currentUser) Then
                    key = screenId & "||" & timeVal
                    Set dataDict = userDict(currentUser)
                    If dataDict.exists(key) Then
                        dataDict(key) = dataDict(key) + 1
                    Else
                        dataDict.Add key, 1
                    End If
                End If
            Next row
        Next ws

        wb.Close False
SkipFile:
        fileName = Dir
    Loop

    ' 結果出力（2ユーザーごと）
    Dim batchCount As Long: batchCount = 0
    Dim savePath As String
    Dim fileUserCount As Long: fileUserCount = 0
    Set resultWb = Nothing
    
    For Each currentUser In userDict.Keys
        If fileUserCount = 0 Then
            Set resultWb = Workbooks.Add
            batchCount = batchCount + 1
        End If
        
        Set resultWs = resultWb.Sheets.Add(After:=resultWb.Sheets(resultWb.Sheets.Count))
        resultWs.Name = currentUser
        
        resultWs.Cells(1, 1).Value = "画面ID"
        resultWs.Cells(1, 2).Value = "時間"
        resultWs.Cells(1, 3).Value = "出現回数"
        
        Set dataDict = userDict(currentUser)
        i = 2
        For Each key In dataDict.Keys
            Dim parts() As String
            parts = Split(key, "||")
            resultWs.Cells(i, 1).Value = parts(0)
            resultWs.Cells(i, 2).Value = parts(1)
            resultWs.Cells(i, 3).Value = dataDict(key)
            i = i + 1
        Next key
        
        fileUserCount = fileUserCount + 1
        
        If fileUserCount = 2 Or currentUser = userDict.Keys(userDict.Count - 1) Then
            savePath = folderPath & "結果_batch" & batchCount & ".xlsx"
            Application.DisplayAlerts = False
            On Error Resume Next
            For Each ws In resultWb.Sheets
                If ws.Name = "Sheet1" Or ws.Name = "Sheet2" Or ws.Name = "Sheet3" Then ws.Delete
            Next ws
            On Error GoTo 0
            Application.DisplayAlerts = True
            resultWb.SaveAs Filename:=savePath
            resultWb.Close False
            fileUserCount = 0
        End If
    Next

    MsgBox "処理が完了しました。"

End Sub


  </div>
</body>
</html>

